name: "Hub Mirror Action."
description: "Mirror the organization repos between hub (github/gitee/gitLab)."
author: "yikun"
branding:
  icon: "upload-cloud"
  color: "gray-dark"
inputs:
  src_key:
    description: "The private SSH key used to fetch code from source hub. Takes precedence over private_key."
    required: false
  dst_key:
    description: "The private SSH key used to push code to destination hub. Takes precedence over private_key."
    required: false
  private_key:
    description: "Fallback private SSH key used when src_key or dst_key is empty."
    required: false
  dst_token:
    description: "The app token which is used to  create repo in destination hub."
    required: true
  dst:
    description: "Destination name. Such as `gitee/kunpengcompute`."
    required: true
  dst_endpoint:
    description: "Destination endpoint for self-hosted, currently only Gitlab is supported, like gitlab.example.com (no https:// prefix)."
    default: ''
  src:
    description: "Source name. Such as `github/kunpengcompute`."
    required: true
  src_endpoint:
    description: "Source endpoint for self-hosted, currently only Gitlab is supported, like gitlab.example.com (no https:// prefix)."
    default: ''
  account_type:
    description: "The account type. Such as org, user, group."
    default: 'user'
  src_account_type:
    description: "The src account type. Such as org, user, group."
    default: ''
  dst_account_type:
    description: "The dst account type. Such as org, user, group."
    default: ''
  clone_style:
    description: "The git clone style, https or ssh."
    default: 'https'
  cache_path:
    description: "The path to cache the source repos code. Relative paths will be prefixed with `github.workspace`."
    default: 'hub-mirror-cache'
  black_list:
    description: "Hight priority, the back list of mirror repo. like 'repo1,repo2,repo3'"
    default: ''
  white_list:
    description: "Low priority, the white list of mirror repo. like 'repo1,repo2,repo3'"
    default: ''
  static_list:
    description: "Only mirror repo in the static list, but don't get from repo api (the white/black list is still available). like 'repo1,repo2,repo3'"
    default: ''
  force_update:
    description: "Force to update the destination repo, use '-f' flag do 'git push'"
    default: false
  debug:
    description: "Enable the debug flag to show detail log"
    default: false
  timeout:
    description: "Set the timeout for every git command, like '600'=>600s, '30m'=>30 mins, '1h'=>1 hours"
    default: '30m'
  api_timeout:
    description: "Set the timeout for API requests (in seconds)."
    default: '60'
  mappings:
    description: "The source repos mappings, such as 'A=>B, C=>CC', source repo name would be mapped follow the rule: A to B, C to CC. Mapping is not transitive."
    default: ''
  lfs:
    description: "Enable Git LFS support."
    default: false
runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Set up uv
      uses: astral-sh/setup-uv@v3

    - name: Compute uv cache key
      id: uv-cache
      uses: actions/github-script@v8
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          const crypto = require('crypto');

          const actionPath = process.env.GITHUB_ACTION_PATH;
          const files = [
            path.join(actionPath, 'hub-mirror', 'uv.lock'),
            path.join(actionPath, 'hub-mirror', 'pyproject.toml'),
          ];
          const hash = crypto.createHash('sha256');
          for (const file of files) {
            hash.update(fs.readFileSync(file));
          }
          core.setOutput('uv_cache_key', hash.digest('hex'));

    - uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-${{ steps.uv-cache.outputs.uv_cache_key }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: Install dependencies
      run: |
        uv sync --project ${{ github.action_path }}/hub-mirror --frozen
      shell: bash

    - name: Configure SSH
      run: |
        set -euo pipefail
        mkdir -p ~/.ssh

        SRC_KEY="${{ inputs.src_key }}"
        DST_KEY="${{ inputs.dst_key }}"
        PRIVATE_KEY="${{ inputs.private_key }}"

        if [[ -z "$PRIVATE_KEY" ]]; then
          if [[ -z "$SRC_KEY" || -z "$DST_KEY" ]]; then
            echo "Error: src_key and dst_key are required unless private_key is set." >&2
            exit 1
          fi
        fi

        if [[ -z "$SRC_KEY" ]]; then
          SRC_KEY="$PRIVATE_KEY"
        fi
        if [[ -z "$DST_KEY" ]]; then
          DST_KEY="$PRIVATE_KEY"
        fi

        printf "%s" "$SRC_KEY" > ~/.ssh/id_rsa_src
        printf "%s" "$DST_KEY" > ~/.ssh/id_rsa_dst
        chmod 600 ~/.ssh/id_rsa_src ~/.ssh/id_rsa_dst
      shell: bash

    - name: Run Hub Mirror
      run: |
        # Set debug mode if requested
        if [[ "${{ inputs.debug }}" == "true" ]]; then
          set -x
        fi
        
        # Ensure git lfs is available
        if ! command -v git-lfs &> /dev/null; then
             sudo apt-get update && sudo apt-get install -y git-lfs
        fi
        git lfs install

        # Resolve cache path to a writable workspace location
        CACHE_PATH="${{ inputs.cache_path }}"
        if [[ "$CACHE_PATH" == /github/workspace* ]]; then
            CACHE_PATH="${{ github.workspace }}${CACHE_PATH#/github/workspace}"
        fi
        if [[ "$CACHE_PATH" != /* ]]; then
            CACHE_PATH="${{ github.workspace }}/$CACHE_PATH"
        fi
        mkdir -p "$CACHE_PATH"
        echo "Using CACHE_PATH: $CACHE_PATH"

        uv run --project ${{ github.action_path }}/hub-mirror hubmirror \
          --src "${{ inputs.src }}" \
          --dst "${{ inputs.dst }}" \
          --dst-token "${{ inputs.dst_token }}" \
          --account-type "${{ inputs.account_type }}" \
          --src-account-type "${{ inputs.src_account_type }}" \
          --dst-account-type "${{ inputs.dst_account_type }}" \
          --clone-style "${{ inputs.clone_style }}" \
          --cache-path "$CACHE_PATH" \
          --black-list "${{ inputs.black_list }}" \
          --white-list "${{ inputs.white_list }}" \
          --static-list "${{ inputs.static_list }}" \
          --force-update "${{ inputs.force_update }}" \
          --debug "${{ inputs.debug }}" \
          --timeout "${{ inputs.timeout }}" \
          --api-timeout "${{ inputs.api_timeout }}" \
          --mappings "${{ inputs.mappings }}" \
          --lfs "${{ inputs.lfs }}"
      shell: bash
